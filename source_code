// ---------- GLOBAL CONSTANTS ----------
const journalFormat = "YYYY-MM-DD";
const MAX_STREAK_GAP = 2; // Maximum days gap allowed between completions
const CANVAS_SIZE = 600;
const RADAR_MAX_RADIUS = 220;
const LABEL_OFFSET = 40;

// Streak color thresholds
const STREAK_THRESHOLDS = {
    excellent: 7,
    good: 3
};

// Progress color thresholds
const PROGRESS_THRESHOLDS = {
    complete: 1,
    partial: 0.7
};

// Color palette
const COLORS = {
    complete: "#10b981",
    partial: "#f59e0b",
    behind: "#ef4444",
    radarFill: "rgba(99, 102, 241, 0.15)",
    radarStroke: "rgba(99, 102, 241, 0.8)"
};

// ---------- FUNCTIONS ----------
function weeklyCount(pages, fieldName, isNumeric = false) {
    const today = moment().startOf("day")
    const weekStart = today.clone().startOf("isoWeek")
    const weekEnd = today.clone().endOf("isoWeek")

    const validEntries = pages
        .where(p => p[fieldName] !== null && p[fieldName] !== undefined)
        .map(p => ({
            date: moment(p.file.name, journalFormat),
            value: p[fieldName]
        }))
        .filter(entry => entry.date.isValid() && entry.date.isBetween(weekStart, weekEnd, null, "[]"))
        .array()
    
    if (isNumeric) {
        return validEntries.reduce((sum, entry) => sum + (Number(entry.value) || 0), 0)
    } else {
        return validEntries.filter(entry => entry.value === true).length
    }
}

function calculateStreak(pages, fieldName, isNumeric = false) {
    const today = moment().startOf("day")
    
    const completedDates = pages
        .where(p => {
            const value = p[fieldName]
            if (isNumeric) {
                return value !== null && value !== undefined && Number(value) > 0
            } else {
                return value === true
            }
        })
        .map(p => moment(p.file.name, journalFormat))
        .filter(d => d.isValid() && d.isSameOrBefore(today))
        .array()
        .sort((a, b) => b.diff(a))
    
    if (completedDates.length === 0) return 0
    
    const mostRecent = completedDates[0]
    const daysSinceLastCompletion = today.diff(mostRecent, 'days')
    
    if (daysSinceLastCompletion > MAX_STREAK_GAP) {
        return 0
    }
    
    let streak = 0
    
    for (let i = 0; i < completedDates.length; i++) {
        const currentDate = completedDates[i]
        streak++
        
        if (i < completedDates.length - 1) {
            const nextDate = completedDates[i + 1]
            const daysBetween = currentDate.diff(nextDate, 'days') - 1
            
            if (daysBetween > MAX_STREAK_GAP) {
                break
            }
        }
    }
    
    return streak
}

// ---------- CONFIG ----------
const today = moment()
const dayOfWeek = today.isoWeekday()

const items = [
    { icon: "ðŸ’ª", label: "Workout", pages: '"02 Workout"', field: "Workout", target: 6, type: "boolean" },
    { icon: "ðŸš´â€â™‚ï¸", label: "Cardio", pages: '"05 Cycling"', field: "Cardio", target: 4, type: "boolean" },
    { icon: "âœ“", label: "NoFap", pages: '"01 Daily Journal"', field: "MasturbationAvoided", target: 7, type: "boolean" },
    { icon: "ðŸ’Š", label: "Medicine", pages: '"01 Daily Journal"', field: "Medicine", target: 7, type: "boolean" },
    { icon: "ðŸ‹ï¸â€â™‚ï¸", label: "GTG", pages: '"01 Daily Journal"', field: "GTG", target: 6, type: "boolean" },
    { icon: "ðŸª´", label: "Water Plants", pages: '"01 Daily Journal"', field: "waterPlants", target: 7, type: "boolean" },
    { icon: "ðŸ“‘", label: "Research", pages: '"01 Daily Journal"', field: "Research", target: 1, type: "boolean" },
    { icon: "ðŸ“„", label: "AcaResearch", pages: '"01 Daily Journal"', field: "AcaResearch", target: 6, type: "boolean" },
    { icon: "ðŸ“–", label: "Reading", pages: '"06 Readings"', field: "Reading", target: 6, type: "boolean" },
    { icon: "ðŸ“š", label: "Study", pages: '"01 Daily Journal"', field: "Study", target: 6, type: "boolean" },
    { icon: "ðŸŽ¸", label: "Guitar", pages: '"03 Guitar Practice"', field: "Guitar", target: 6, type: "boolean" },
    { icon: "ðŸ", label: "Python", pages: '"04 Learning Python"', field: "Python", target: 6, type: "boolean" },
    { icon: "ðŸŽï¸", label: "Gaming", pages: '"01 Daily Journal"', field: "Gaming", target: 7, type: "boolean" },
    { icon: "ðŸ–¥ï¸", label: "Journal", pages: '"01 Daily Journal"', field: "DJournal", target: 7, type: "boolean" },
    { icon: "ðŸ’µ", label: "Money", pages: '"01 Daily Journal"', field: "moneySpent", target: 1000, type: "numeric" }
]

const data = items.map(item => {
    const pages = dv.pages(item.pages)
    const isNumeric = item.type === "numeric"
    const done = weeklyCount(pages, item.field, isNumeric)
    const streak = calculateStreak(pages, item.field, isNumeric)
    const progress = Math.min(done / item.target, 1)
    return {
        ...item,
        done: isNumeric ? Math.round(done * 10) / 10 : done,
        streak,
        progress
    }
})

// ---------- RENDER ----------
const container = dv.el("div", "", {
    attr: {
        style: `
        padding: 40px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        `
    }
})

// Header
const header = dv.el("div", "", {
    attr: {
        style: `
        text-align: center;
        margin-bottom: 40px;
        `
    }
})

header.appendChild(
    dv.el("div", "Weekly Radar", {
        attr: {
            style: `
            font-size: 1.3em;
            font-weight: 300;
            color: var(--text-muted);
            letter-spacing: 0.12em;
            margin-bottom: 4px;
            `
        }
    })
)

header.appendChild(
    dv.el("div", `week ${today.isoWeek()}`, {
        attr: {
            style: `
            font-size: 0.8em;
            color: var(--text-faint);
            letter-spacing: 0.08em;
            `
        }
    })
)

container.appendChild(header)

// Canvas for radar chart with high-DPI support
const canvas = document.createElement("canvas")
const ctx = canvas.getContext("2d")

const dpr = window.devicePixelRatio || 1
const logicalWidth = CANVAS_SIZE
const logicalHeight = CANVAS_SIZE

canvas.width = logicalWidth * dpr
canvas.height = logicalHeight * dpr

canvas.style.width = logicalWidth + "px"
canvas.style.height = logicalHeight + "px"
canvas.style.maxWidth = "100%"
canvas.style.height = "auto"

ctx.scale(dpr, dpr)

const centerX = logicalWidth / 2
const centerY = logicalHeight / 2
const maxRadius = RADAR_MAX_RADIUS
const numItems = data.length

// Draw background circles
ctx.strokeStyle = "rgba(128, 128, 128, 0.1)"
ctx.lineWidth = 1
for (let i = 1; i <= 5; i++) {
    ctx.beginPath()
    ctx.arc(centerX, centerY, (maxRadius / 5) * i, 0, Math.PI * 2)
    ctx.stroke()
}

// Draw axes
ctx.strokeStyle = "rgba(128, 128, 128, 0.15)"
ctx.lineWidth = 1
for (let i = 0; i < numItems; i++) {
    const angle = (Math.PI * 2 * i) / numItems - Math.PI / 2
    const x = centerX + Math.cos(angle) * maxRadius
    const y = centerY + Math.sin(angle) * maxRadius
    
    ctx.beginPath()
    ctx.moveTo(centerX, centerY)
    ctx.lineTo(x, y)
    ctx.stroke()
}

// Draw progress polygon
ctx.fillStyle = COLORS.radarFill
ctx.strokeStyle = COLORS.radarStroke
ctx.lineWidth = 2.5

ctx.beginPath()
for (let i = 0; i < numItems; i++) {
    const angle = (Math.PI * 2 * i) / numItems - Math.PI / 2
    const radius = maxRadius * data[i].progress
    const x = centerX + Math.cos(angle) * radius
    const y = centerY + Math.sin(angle) * radius
    
    if (i === 0) {
        ctx.moveTo(x, y)
    } else {
        ctx.lineTo(x, y)
    }
}
ctx.closePath()
ctx.fill()
ctx.stroke()

// Draw points on progress line
for (let i = 0; i < numItems; i++) {
    const angle = (Math.PI * 2 * i) / numItems - Math.PI / 2
    const radius = maxRadius * data[i].progress
    const x = centerX + Math.cos(angle) * radius
    const y = centerY + Math.sin(angle) * radius
    
    ctx.fillStyle = data[i].progress >= PROGRESS_THRESHOLDS.complete ? COLORS.complete : 
                    data[i].progress >= PROGRESS_THRESHOLDS.partial ? COLORS.partial : COLORS.behind
    ctx.beginPath()
    ctx.arc(x, y, 5, 0, Math.PI * 2)
    ctx.fill()
}

// Draw labels
ctx.font = "14px system-ui, -apple-system, sans-serif"
ctx.textAlign = "center"
ctx.textBaseline = "middle"

for (let i = 0; i < numItems; i++) {
    const angle = (Math.PI * 2 * i) / numItems - Math.PI / 2
    const labelRadius = maxRadius + LABEL_OFFSET
    const x = centerX + Math.cos(angle) * labelRadius
    const y = centerY + Math.sin(angle) * labelRadius
    
    // Draw emoji
    ctx.font = "20px system-ui, -apple-system, sans-serif"
    ctx.fillStyle = "rgba(255, 255, 255, 0.9)"
    ctx.fillText(data[i].icon, x, y - 20)
    
    // Draw streak
    ctx.font = "bold 11px system-ui, -apple-system, sans-serif"
    const streakColor = data[i].streak >= STREAK_THRESHOLDS.excellent ? COLORS.complete : 
                        data[i].streak >= STREAK_THRESHOLDS.good ? COLORS.partial : COLORS.behind
    ctx.fillStyle = streakColor
    ctx.fillText(`${data[i].streak}ðŸ”¥`, x, y - 3)
    
    // Draw label
    ctx.font = "11px system-ui, -apple-system, sans-serif"
    ctx.fillStyle = "rgba(150, 150, 150, 0.8)"
    ctx.fillText(data[i].label, x, y + 11)
    
    // Draw progress fraction
    ctx.font = "10px system-ui, -apple-system, sans-serif"
    ctx.fillStyle = "rgba(120, 120, 120, 0.7)"
    ctx.fillText(`${data[i].done}/${data[i].target}`, x, y + 24)
}

container.appendChild(canvas)

// Legend
const legend = dv.el("div", "", {
    attr: {
        style: `
        margin-top: 30px;
        display: flex;
        gap: 24px;
        justify-content: center;
        font-size: 0.85em;
        `
    }
})

const legendItems = [
    { color: COLORS.complete, label: "Complete" },
    { color: COLORS.partial, label: "Partial" },
    { color: COLORS.behind, label: "Behind" }
]

legendItems.forEach(item => {
    const legendItem = dv.el("div", "", {
        attr: {
            style: `
            display: flex;
            align-items: center;
            gap: 8px;
            `
        }
    })
    
    legendItem.appendChild(
        dv.el("div", "", {
            attr: {
                style: `
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: ${item.color};
                `
            }
        })
    )
    
    legendItem.appendChild(
        dv.el("span", item.label, {
            attr: {
                style: `
                color: var(--text-muted);
                `
            }
        })
    )
    
    legend.appendChild(legendItem)
})

container.appendChild(legend)